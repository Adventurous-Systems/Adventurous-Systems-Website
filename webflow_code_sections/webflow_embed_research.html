<section id="as-publications" style="all:initial;display:block;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;">
  <style>
    /* Scope everything */
    #as-publications *{box-sizing:border-box}
    #as-publications{scroll-behavior:smooth}

    /* Layout */
    #as-publications{background:#fff;color:#1d1d1f}
    /* #as-publications .wrap{all:revert;max-width:1280px;margin:0 auto;padding:50px 24px} */
    #as-publications .wrap{all:revert;max-width:1280px;margin:0 auto;padding:50px 24px 0px}


    /* Header */
    #as-publications .kicker{
      letter-spacing:.1em;text-transform:uppercase;color:#1d1d1f;font-size:13px;
      text-align:center;margin-bottom:16px;font-weight:500
    }
    #as-publications h2.section-title{
      font-size:clamp(28px,3vw,36px);text-align:center;margin:0 0 12px;font-weight:600;color:#1d1d1f
    }
    #as-publications p.section-intro{
      text-align:center;color:#4a4a4a;font-size:16px;margin:0 auto 24px;max-width:720px;line-height:1.55
    }

    /* Meta row (counts) */
    #as-publications .meta-row{
      display:flex;justify-content:flex-end;align-items:center;gap:12px;
      max-width:1200px;margin:0 auto 14px
    }
    #as-publications .count{font-size:13px;color:#86868b;font-weight:500}

    /* Filter carousel */
    #as-publications .filters-wrap{max-width:1200px;margin:0 auto 32px;position:relative;padding:0 60px}
    #as-publications .filters-viewport{overflow:hidden;padding:8px 0;margin:-8px 0}
    #as-publications .filters-track{display:flex;gap:10px;transition:transform .35s cubic-bezier(0.4, 0, 0.2, 1)}
    #as-publications .filter-btn{
      all:unset;cursor:pointer;border:1px solid #d2d2d7;padding:8px 16px;border-radius:999px;
      font-size:13px;color:#1d1d1f;white-space:nowrap;transition:all .2s ease
    }
    #as-publications .filter-btn:hover{background:#f5f5f7;transform:translateY(-1px)}
    #as-publications .filter-btn:focus-visible{outline:2px solid #1d1d1f;outline-offset:2px}
    #as-publications .filter-btn.is-active{background:#1d1d1f;color:#fff;border-color:#1d1d1f}
    #as-publications .filters-nav{
      position:absolute;top:50%;transform:translateY(-50%);z-index:2;
      opacity:1;transition:opacity .2s ease
    }
    #as-publications .filters-nav.hidden{opacity:0;pointer-events:none}
    #as-publications .filters-prev{left:0}
    #as-publications .filters-next{right:0}
    /* Enhanced icon button with SVG arrows */
    #as-publications .icon-btn{
      all:unset;cursor:pointer;width:40px;height:40px;border:1px solid #d2d2d7;border-radius:50%;
      display:flex;align-items:center;justify-content:center;background:#fff;
      transition:all .25s ease;box-shadow:0 1px 3px rgba(0,0,0,.04)
    }
    #as-publications .icon-btn:hover{
      border-color:#1d1d1f;box-shadow:0 4px 12px rgba(0,0,0,.1);transform:scale(1.05)
    }
    #as-publications .icon-btn:focus-visible{outline:2px solid #1d1d1f;outline-offset:2px}
    #as-publications .icon-btn:active{transform:scale(0.98)}
    #as-publications .icon-btn svg{width:16px;height:16px;stroke:#1d1d1f;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none}

    /* Card carousel */
    #as-publications .carousel{max-width:1200px;margin:0 auto;position:relative;padding:0 52px}
    #as-publications .carousel-viewport{overflow:hidden;padding:8px 0;margin:-8px 0}
    #as-publications .carousel-track{
      display:flex;gap:20px;transition:transform .35s cubic-bezier(0.4, 0, 0.2, 1)
    }
    /* The magic: each card takes 1/3 (minus gaps) on desktop, 1/2 on tablet, full on mobile */
    #as-publications .pub-card{
      flex:0 0 calc((100% - 40px) / 3); /* 3 columns, two gaps (2*20px) */
      background:#fff;border:1px solid #d2d2d7;border-radius:18px;padding:20px;
      display:flex;flex-direction:column;gap:0;
      transition:box-shadow .25s ease,transform .25s ease,border-color .25s ease;
      animation:fadeIn .4s ease-out backwards
    }
    #as-publications .pub-card:hover,
    #as-publications .pub-card:focus-within{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.08);border-color:#b8b8bd}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    #as-publications .pub-title{
      font-size:18px;font-weight:600;color:#1d1d1f;line-height:1.3;margin:0 0 10px;
      min-height:calc(1.3em * 2);display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden
    }
    #as-publications .pub-summary{
      font-size:14px;color:#4a4a4a;line-height:1.55;margin:0 0 12px;
      display:-webkit-box;-webkit-line-clamp:3;line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;min-height:calc(1.55em * 3)
    }
    #as-publications .pub-meta{font-size:13px;color:#86868b;margin:0 0 10px}
    #as-publications .badges{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:auto;padding-bottom:12px;min-height:28px}
    #as-publications .badge{
      font-size:11px;color:#1d1d1f;border:1px solid #d2d2d7;padding:4px 8px;border-radius:999px;white-space:nowrap;
      transition:background .2s ease,border-color .2s ease
    }
    #as-publications .badge:hover{background:#f5f5f7;border-color:#b8b8bd}
    #as-publications .pub-actions{display:flex;gap:10px;margin-top:0}
    #as-publications .pub-link{
      text-decoration:none;font-size:14px;color:#1d1d1f;border:1px solid #1d1d1f;border-radius:10px;padding:8px 12px;
      transition:all .2s ease
    }
    #as-publications .pub-link:hover{background:#1d1d1f;color:#fff;transform:translateY(-1px)}
    #as-publications .pub-link:focus-visible{outline:2px solid #1d1d1f;outline-offset:2px}
    #as-publications .carousel-nav{
      position:absolute;top:50%;transform:translateY(-50%);z-index:2;
      opacity:1;transition:opacity .2s ease
    }
    #as-publications .carousel-nav.hidden{opacity:0;pointer-events:none}
    #as-publications .carousel-prev{left:0}
    #as-publications .carousel-next{right:0}

    /* CTA */
    #as-publications .cta{text-align:center;margin-top:32px}
    #as-publications .cta a{
      text-decoration:none;display:inline-block;border:1px solid #1d1d1f;padding:10px 16px;border-radius:12px;color:#1d1d1f;
      transition:all .2s ease
    }
    #as-publications .cta a:hover{background:#1d1d1f;color:#fff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    #as-publications .cta a:focus-visible{outline:2px solid #1d1d1f;outline-offset:2px}

    /* Responsive widths for cards */
    @media (max-width:991px){
      #as-publications .pub-card{flex:0 0 calc((100% - 20px) / 2)} /* 2 columns */
    }
    @media (max-width:640px){
      /* #as-publications .wrap{padding:30px 20px} */
      #as-publications .wrap{padding:30px 20px 16px}
      #as-publications .pub-card{flex:0 0 100%} /* 1 column */
      #as-publications .pub-title{font-size:17px;min-height:calc(1.3em * 2)}
      #as-publications .pub-summary{-webkit-line-clamp:2;line-clamp:2;min-height:calc(1.55em * 2)}
      #as-publications .filters-wrap,
      #as-publications .carousel{padding:0 50px} /* Reduce padding for smaller screens */
      #as-publications .icon-btn{width:36px;height:36px} /* Slightly smaller buttons on mobile */
      #as-publications .icon-btn svg{width:14px;height:14px}
    }
  </style>

  <!-- Data block: edit titles/summaries/links/tags. Add/remove items as needed. -->
  <script type="application/json" id="as-publications-data">
  {
    "title": "PUBLICATIONS & RESEARCH",
    "heading": "Turning peer-reviewed insight into built-environment impact.",
    "intro": "We collaborate with universities, reuse hubs, and industry partners to publish open research advancing digital twins, material circularity, and AI readiness in AEC.",
    "priorityTags": ["DigitalTwin","TRACE","Blockchain","AI","DeFab","BIM","Compliance","Governance"],
    "items": [
      { "title": "Classification of AI Techniques for Early Architectural Design Stages", "summary": "Survey and classification of AI approaches to support early-stage design decisions.", "tags": ["AI","Architecture","Design"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/382564221_Classification_of_artificial_intelligence_techniques_for_early_architectural_design_stages"}] },
      { "title": "Textual & Visual Interpretation in a Text-to-Image Accelerated Architectural Design Process", "summary": "Explores text+image prompting for speed and fidelity in concept design workflows.", "tags": ["AI","Architecture","TextToImage"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/391064641_Textual_and_Visual_Interpretation_in_a_Text-to-Image_Accelerated_Architectural_Design_Process"}] },
      { "title": "Spatial Interpretation in a Diffusion-powered Accelerated Architectural Design Process", "summary": "Investigates diffusion models for spatial reasoning in architectural proposals.", "tags": ["AI","Architecture","Diffusion"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/391451019_Spatial_Interpretation_in_a_Diffusion-powered_Accelerated_Architectural_Design_Process"}] },
      { "title": "Spatial Interpretation in a Text-to-Image Accelerated Architectural Design Process", "summary": "Assesses how text-to-image systems interpret spatial constraints in design.", "tags": ["AI","Architecture","TextToImage"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/385902351_Spatial_Interpretation_in_a_Text-to-image_Accelerated_Architectural_Design_Process"}] },

      { "title": "Blockchain Weaving as Architecture", "summary": "Framework for transforming nomadic weaving heritage into immutable digital memory.", "tags": ["Blockchain","Heritage","Architecture"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/396186043_BLOCKCHAIN_WEAVING_AS_ARCHITECTURE_A_framework_for_transforming_the_nomadic_heritage_into_immutable_memory"}] },
      { "title": "Decentralising Architectural Design Through Data Governance", "summary": "Data-governance patterns for decentralising architectural decision-making.", "tags": ["Blockchain","Governance","Design"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/391590351_Decentralising_architectural_design_through_data_governance"}] },
      { "title": "Digital Building Logbooks on the Blockchain", "summary": "Concept and research pathways for blockchain-anchored building logbooks.", "tags": ["Blockchain","BIM","Compliance"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/391584150_Digital_building_logbooks_on_the_blockchain_first_conceptualisation_and_future_research_directions"}] },
      { "title": "Application of SBTs for DAOs in Architecture", "summary": "Soulbound token primitives for identity and governance in design DAOs.", "tags": ["Blockchain","DAO","Tokens"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/395124725_Application_of_Soulbound_Tokens_for_Decentralised_Autonomous_Organizations_in_Architecture"}] },
      { "title": "Economy & Community as Bottom-Up Drivers for Design", "summary": "Coordinating dashboards as socio-technical drivers for design ecosystems.", "tags": ["Design","Governance","Dashboards"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/385902042_Economy_and_Community_as_Bottom-Up_Drivers_for_Design_Creating_coordinating_dashboards_for_architectural_design"}] },
      { "title": "Potential Value of Tokens & Token Engineering for AEC", "summary": "Token engineering as a lever for incentives and transparency in AEC.", "tags": ["TokenEngineering","AEC"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/372244319_What_is_the_potential_value_of_tokens_and_token_engineering_for_the_architecture_engineering_and_construction_industry_A_positional_paper"}] },
      { "title": "Design Dimensions for Blockchain Oracles in AEC", "summary": "Oracle patterns to bring real-world data into AEC smart contracts.", "tags": ["Oracles","Blockchain","AEC"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/372244225_Design_dimensions_for_blockchain_oracles_in_the_AEC_industry"}] },
      { "title": "DAOs for the AEC & Design Industries", "summary": "DAO governance models and implications for design/construction workflows.", "tags": ["DAO","AEC","Governance"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/363711951_Decentralised_Autonomous_Organisations_for_the_AEC_and_Design_Industries"}] },

      { "title": "Blockchain for Construction (Springer Book)", "summary": "Comprehensive treatment of blockchain applications across construction.", "tags": ["Blockchain","Construction","Book"], "links": [{"label":"Book","url":"https://link.springer.com/book/10.1007/978-981-19-3759-0"}] },
      { "title": "The Promise of Blockchain for the Construction Industry", "summary": "Frames blockchain adoption through governance structures and incentives.", "tags": ["Governance","Construction","Blockchain"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/363711482_The_Promise_of_Blockchain_for_the_Construction_Industry_A_Governance_Lens"}] },
      { "title": "Collective Digital Factories for Buildings", "summary": "Stigmergic collaboration & cryptoeconomic coordination for building delivery.", "tags": ["Cryptoeconomics","Collaboration","Construction"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/363695488_Collective_Digital_Factories_for_Buildings_Stigmergic_Collaboration_Through_Cryptoeconomics"}] },
      { "title": "Crypto: New Political Economy in Architecture", "summary": "Crypto’s political-economy implications in architectural practice.", "tags": ["Architecture","Economy","Blockchain"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/363641362_Crypto_towards_a_New_Political_Economy_in_Architecture_-_Prospectives"}] },
      { "title": "The Architecture DAO", "summary": "Stigmergy & DAO mechanisms for collaborative design work.", "tags": ["DAO","Architecture","Collaboration"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/362404374_The_Architecture_Decentralised_Autonomous_Organisation_A_stigmergic_exploration_in_architectural_collaboration"}] },
      { "title": "Invoice Smart Contracts for Design SMEs", "summary": "Smart-contract invoicing patterns tailored to SME design practices.", "tags": ["SmartContracts","SME","AEC"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/354413081_Invoice_Smart_Contracts_for_Design_SMEs"}] },
      { "title": "BIM & Blockchain Integration", "summary": "Integrates BIM processes with blockchain for trustable coordination.", "tags": ["BIM","Blockchain","Design"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/344646823_Framework_for_decentralised_architectural_design_BIM_and_Blockchain_integration"}] },
      { "title": "Smart Contracts for Decentralised BIM", "summary": "Smart-contract primitives enabling decentralised BIM collaboration.", "tags": ["BIM","SmartContracts","AEC"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/343509689_Smart_Contracts_for_Decentralised_Building_Information_Modelling"}] },

      { "title": "Non-Fungible Building Components (TRACE)", "summary": "Smart contracts to track and trade reclaimed building components.", "tags": ["TRACE","NFT","CircularEconomy"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/358607327_Non-Fungible_Building_Components_Using_Smart_Contracts_for_a_Circular_Economy_in_the_Built_Environment"}] },
      { "title": "Topology-Generated NFTs for Circular Design (TRACE)", "summary": "Topology-driven NFTs as infrastructure for circularity.", "tags": ["TRACE","NFT","Topology"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/367695586_Topology_Generated_Non-Fungible_Tokens_-_Blockchain_as_infrastructure_for_a_circular_economy_in_architectural_design"}] },

      { "title": "Discretisation Strategies in Architectural Design", "summary": "Procedural classification system for discretisation in design.", "tags": ["Automation","Fabrication","Design"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/388763616_Discretisation_strategies_in_the_architectural_design_process_a_procedural_classification_system"}] },
      { "title": "Discrete Design — Methodological Classification", "summary": "Methodology for discrete design choices across fabrication pipelines.", "tags": ["Automation","Fabrication","Design"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/381769025_Discretisation_Design_Strategies_Discrete_Design_Methodological_Classification"}] },
      { "title": "Integrating Design & Fabrication via Discretisation", "summary": "Bridging design and making via discrete strategies and standards.", "tags": ["Automation","Fabrication","Integration"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/394190979_Strategies_to_Integrate_Design_and_Fabrication_through_Discretisation"}] },

      { "title": "Building Standards & Warrants in Scotland", "summary": "Building-information repositories to streamline approvals.", "tags": ["BuildingStandards","Scotland","Compliance"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/383013744_Navigating_Building_Standards_and_Building_Warrant_Processes_in_Scotland_Building_Information_Repositories"}] },

      { "title": "Federated Digital Twin of Social Housing", "summary": "Country-level DT model for housing with blockchain verification.", "tags": ["DigitalTwin","Blockchain","Housing"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/395124336_Exploring_Pathways_for_Country-level_Blockchain-driven_Federated_Digital_Twining_of_Social_Housing"}] },
      { "title": "CRYPTO-TWIN Framework for AEC", "summary": "Blueprint for enabling digital twins with blockchain.", "tags": ["DigitalTwin","Blockchain","AEC"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/371024810_A_CRYPTO-TWIN_FRAMEWORK_FOR_THE_AEC_INDUSTRY_-_ENABLING_DIGITAL_TWINS_WITH_BLOCKCHAIN_TECHNOLOGIES"}] },

      { "title": "Decentralised Physical Infrastructure for AM", "summary": "Tamper-proof linkage between designs, blockchains, and 3D printers.", "tags": ["DeFab","AdditiveManufacturing","Infrastructure"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/384327395_Towards_a_Decentralized_Physical_Infrastructure_for_Additive_Manufacturing_in_Architecture_A_proof_of_concept_for_a_tamper_proof_secure_connection_between_designs_blockchains_and_3d_printers"}] },
      { "title": "Decentralised AM for Architecture", "summary": "Decentralised manufacturing patterns for architectural use-cases.", "tags": ["DeFab","AdditiveManufacturing","Architecture"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/373998821_Decentralised_Additive_Manufacturing_for_Architecture"}] },
      { "title": "Workflow for Performance & Grade of 3DCP", "summary": "DeSci-style workflow to standardise and industrialise 3D concrete printing.", "tags": ["DeFab","3DCP","Standards"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/395723639_A_Streamlined_Decentralised_Workflow_for_Obtaining_Specific_Mechanical_Performance_and_Grade_of_3DPC_Towards_the_Standardisation_and_Industrialisation_of_3DCP"}] },
      { "title": "Framework for Standardisation of 3DCP via DeSci", "summary": "Theoretical framework to accelerate 3DCP industrialisation via DeSci.", "tags": ["DeSci","3DCP","Standards"], "links": [{"label":"Read","url":"https://www.researchgate.net/publication/391848336_A_Theoretical_Framework_for_the_Standardisation_and_Industrialisation_of_3D_Concrete_Printing_through_Decentralised_Science"}] }
    ]
  }
  </script>

  <div class="wrap">
    <div class="kicker" id="pubs-kicker"></div>
    <h2 class="section-title" id="pubs-title"></h2>
    <p class="section-intro" id="pubs-intro"></p>

    <div class="meta-row">
      <div class="count" id="items-count"></div>
    </div>

    <!-- Filter carousel -->
    <div class="filters-wrap">
      <div class="filters-viewport">
        <div class="filters-track" id="filters-track"></div>
      </div>
      <div class="filters-nav filters-prev">
        <button class="icon-btn" id="filters-prev" aria-label="Previous filters">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
      </div>
      <div class="filters-nav filters-next">
        <button class="icon-btn" id="filters-next" aria-label="Next filters">
          <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
      </div>
    </div>

    <!-- Cards carousel -->
    <div class="carousel">
      <div class="carousel-viewport">
        <div class="carousel-track" id="cards-track"></div>
      </div>
      <div class="carousel-nav carousel-prev">
        <button class="icon-btn" id="cards-prev" aria-label="Previous publications">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
      </div>
      <div class="carousel-nav carousel-next">
        <button class="icon-btn" id="cards-next" aria-label="Next publications">
          <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
      </div>
    </div>

    <!-- <div class="cta" id="pubs-cta"></div> -->
  </div>

  <script>
    (function(){
      const data = JSON.parse(document.getElementById('as-publications-data').textContent);

      // Headings
      document.getElementById('pubs-kicker').textContent = data.title || 'PUBLICATIONS & RESEARCH';
      document.getElementById('pubs-title').textContent  = data.heading || '';
      document.getElementById('pubs-intro').textContent  = data.intro || '';

      // CTA (optional)
      const cta = document.getElementById('pubs-cta');
      if (data.library && data.library.url){
        const a=document.createElement('a');
        a.href=data.library.url; a.target='_blank'; a.rel='noopener noreferrer';
        a.textContent=data.library.text||'Open Research Library →';
        cta.appendChild(a);
      }

      /* ---------- Tag ranking (best narrative fit first) ---------- */
      const priority = Array.isArray(data.priorityTags)?data.priorityTags:[];
      const items = Array.isArray(data.items)?data.items:[];
      const tagFreq = new Map();
      items.forEach(it => (it.tags||[]).forEach(t => tagFreq.set(t,(tagFreq.get(t)||0)+1)));
      let tags = [...tagFreq.keys()];
      // Sort by: in priority list first (by priority order), then by frequency desc, then alphabetically
      tags.sort((a,b)=>{
        const ai = priority.indexOf(a), bi = priority.indexOf(b);
        if (ai !== -1 || bi !== -1){
          if (ai === -1) return 1;
          if (bi === -1) return -1;
          if (ai !== bi) return ai - bi;
        }
        const fa = tagFreq.get(a)||0, fb = tagFreq.get(b)||0;
        if (fb !== fa) return fb - fa;
        return a.localeCompare(b);
      });

      /* ---------- FILTERS CAROUSEL ---------- */
      const filtersTrack = document.getElementById('filters-track');
      const filtersPrev  = document.getElementById('filters-prev');
      const filtersNext  = document.getElementById('filters-next');

      let activeTag = ''; // empty = All
      let filterIndex = 0; // index of first visible filter
      const VISIBLE_FILTERS = () => window.innerWidth<=640 ? 2 : (window.innerWidth<=991 ? 4 : 5);

      // Build all filter buttons once (including "All")
      const allTags = ['__ALL__', ...tags];
      
      function renderFilters(){
        filtersTrack.innerHTML = '';
        allTags.forEach(t=>{
          const btn=document.createElement('button');
          btn.className='filter-btn'+((t==='__ALL__' && activeTag==='')||(t===activeTag)?' is-active':'');
          btn.textContent=(t==='__ALL__'?'All':'#'+t);
          btn.addEventListener('click',()=>{
            activeTag = (t==='__ALL__') ? '' : t;
            [...filtersTrack.querySelectorAll('.filter-btn')].forEach(b=>b.classList.remove('is-active'));
            btn.classList.add('is-active');
            cardsIndex=0;
            renderCards();
          });
          filtersTrack.appendChild(btn);
        });
        // Small delay to ensure DOM is ready for width calculations
        setTimeout(translateFilters, 10);
      }

      function translateFilters(){
        const buttons = filtersTrack.querySelectorAll('.filter-btn');
        if (!buttons.length){ filtersTrack.style.transform='translateX(0)'; return; }
        
        // Calculate offset by summing actual button widths up to filterIndex
        let offset = 0;
        const gap = 10; // from CSS
        for(let i = 0; i < filterIndex && i < buttons.length; i++){
          offset += buttons[i].getBoundingClientRect().width + gap;
        }
        filtersTrack.style.transform = `translateX(-${offset}px)`;
        
        // Show/hide nav arrows
        const total = allTags.length;
        const vis = VISIBLE_FILTERS();
        const needsNav = total > vis;
        filtersPrev.parentElement.classList.toggle('hidden', !needsNav);
        filtersNext.parentElement.classList.toggle('hidden', !needsNav);
      }

      function moveFilters(dir){
        const total = allTags.length;
        const vis = VISIBLE_FILTERS();
        if (total <= vis) return;
        const maxIndex = Math.max(0, total - vis);
        filterIndex += dir;
        // Ensure we don't go beyond the max index
        if (filterIndex > maxIndex) filterIndex = 0; // wrap to start
        if (filterIndex < 0) filterIndex = maxIndex; // wrap to end
        translateFilters();
      }
      filtersPrev.addEventListener('click',()=>moveFilters(-1));
      filtersNext.addEventListener('click',()=>moveFilters(1));

      /* ---------- CARDS CAROUSEL ---------- */
      const cardsTrack = document.getElementById('cards-track');
      const cardsPrev  = document.getElementById('cards-prev');
      const cardsNext  = document.getElementById('cards-next');
      const itemsCount = document.getElementById('items-count');

      let cardsIndex = 0; // index of first visible card

      const VISIBLE_CARDS = () => window.innerWidth<=640 ? 1 : (window.innerWidth<=991 ? 2 : 3);

      function filteredItems(){
        return items.filter(it => !activeTag || (it.tags||[]).includes(activeTag));
      }

      function renderCards(){
        const dataItems = filteredItems();
        const vis = VISIBLE_CARDS();
        const total = dataItems.length;
        const filterText = activeTag ? `#${activeTag}` : 'All';
        itemsCount.textContent = `${total} publication${total!==1?'s':''} · ${filterText}`;

        // Build the track content (we render all, but viewport shows vis at a time)
        cardsTrack.innerHTML='';
        dataItems.forEach((item,idx)=>{
          const card=document.createElement('article');
          card.className='pub-card';
          card.style.animationDelay=`${idx*0.05}s`;

          const t=document.createElement('h3'); t.className='pub-title'; t.textContent=item.title||'';
          const s=document.createElement('p'); s.className='pub-summary'; s.textContent=item.summary||'';
          const m=document.createElement('p'); m.className='pub-meta';
          m.textContent=[(item.partners||[]).join(' · '), item.year].filter(Boolean).join(' · ');

          const badges=document.createElement('div'); badges.className='badges';
          (item.tags||[]).forEach(tag=>{const b=document.createElement('span'); b.className='badge'; b.textContent='#'+tag; badges.appendChild(b);});

          const actions=document.createElement('div'); actions.className='pub-actions';
          (item.links||[]).forEach(link=>{const a=document.createElement('a'); a.className='pub-link'; a.href=link.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=link.label; actions.appendChild(a);});

          card.append(t,s,m);
          if ((item.tags||[]).length) card.appendChild(badges);
          if ((item.links||[]).length) card.appendChild(actions);
          cardsTrack.appendChild(card);
        });

        // Clamp/wrap index then translate
        if (total===0){ cardsIndex=0; cardsTrack.style.transform='translateX(0)'; return; }
        const maxIndex = Math.max(0, total - vis);
        if (cardsIndex > maxIndex) cardsIndex = 0;
        if (cardsIndex < 0) cardsIndex = maxIndex;

        translateCards();
      }

      function translateCards(){
        // Compute a single card width including gap via first card
        const first = cardsTrack.querySelector('.pub-card');
        if (!first){ cardsTrack.style.transform='translateX(0)'; return; }
        const style = window.getComputedStyle(first);
        const cardW = first.getBoundingClientRect().width;
        const gap   = parseFloat(window.getComputedStyle(cardsTrack).columnGap || style.marginRight || 20);
        const step  = cardW + 20; // gap is 20 via CSS above
        const offset = -(cardsIndex * step);
        cardsTrack.style.transform = `translateX(${offset}px)`;
        
        // Show/hide nav arrows
        const total = filteredItems().length;
        const vis = VISIBLE_CARDS();
        const needsNav = total > vis;
        cardsPrev.parentElement.classList.toggle('hidden', !needsNav);
        cardsNext.parentElement.classList.toggle('hidden', !needsNav);
      }

      function moveCards(dir){
        const total = filteredItems().length;
        const vis = VISIBLE_CARDS();
        if (total <= vis) return; // no need to move
        const maxIndex = Math.max(0, total - vis);
        cardsIndex += dir;
        if (cardsIndex > maxIndex) cardsIndex = 0;          // wrap
        if (cardsIndex < 0) cardsIndex = maxIndex;          // wrap
        translateCards();
      }
      cardsPrev.addEventListener('click',()=>moveCards(-1));
      cardsNext.addEventListener('click',()=>moveCards(1));

      // Initial render
      renderFilters();
      renderCards();

      // Reflow on resize
      let resizeTO;
      window.addEventListener('resize', ()=>{
        clearTimeout(resizeTO);
        resizeTO=setTimeout(()=>{ 
          filterIndex = 0; // reset to start on resize
          // Delay to ensure elements are resized properly
          setTimeout(translateFilters, 50); 
          renderCards(); 
        }, 120);
      });

      // Keyboard accessibility: arrow keys when focused inside section
      document.getElementById('as-publications').addEventListener('keydown', (e)=>{
        if (e.key==='ArrowRight'){ moveCards(1); }
        if (e.key==='ArrowLeft'){  moveCards(-1); }
      });
    })();
  </script>
</section>
